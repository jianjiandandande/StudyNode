---
title: 组网复习
---

## 第二章 以太网

数据链路层可分为两个部分：

* 逻辑链路控制子层(LLC)
* 媒体访问控制子层(MAC)：制定如何使用传输媒体的通信协议。


在IEEE802.3以太网标准的CSMA/CD协议中，MAC子层规定如何在总线型网络结构下使用传输媒体。它的功能有两个：

* 数据帧的封装和解封装，包括寻址和错误检测

* 截止管理，包括介质分配(避免碰撞)和竞争裁决(碰撞处理)。

MAC地址共有3类：
* 单播：第一字节的最低位为0，可作为目的地址和源地址
* 多播：第1个字节的最低位为1，仅能作为目的地址
* 广播：48位全部为1

**带冲突检测的载波侦听多路访问(CSMA/CD)**

* 是半双工的以太网的工作模式
* 应用于OSI参考模型的数据链路层，是一种常用的采用争用方法来决定对传输通道的访问权的协议

3个关键术语的含义：
*  载波侦听：发送结点在发送数据之前，必须侦听传输介质(信道)是否处于空闲状态。
*  多路访问：具有两种含义，既表示多个结点可以同时访问信道，也表示一个结点发送的数据可以被多个结点所接收。
*  冲突检测：发送结点在发出数据的同时，还可以监听信道，判断是否发生冲突(同一时刻，有无其他结点也在发送数据)

**以太网的帧格式与802.3帧格式的区别**

目前，最常见的以太网帧结构是`Ethernet II`的格式。`Ethernet II`和802.3两种标准的帧是用“类型/长度”字段的值来区分(即源地址后的2字节内容)的，该字段的值大于或等于0x0600时，表示上层数据使用的协议类型，例如0x0806表示ARP请求或应答，0x0800表示IP协议；该字段的值小于0xx600时，表示的是一台网用户数据的长度。

`Enthernet II`标准的以太网帧结构如下图所示：


| 目的地址 | 源地址 | 类型  | 数据        | FCS   |
| -------- | ------ | ----- | ----------- | ----- |
| 6字节 | 6字节  | 2字节 | 46~1500字节 | 4字节 |

其中，各字段的意义如下：

* 目的地址：接收端的MAC地址，长度为6字节
* 源地址：发送端的MAC地址，长度为6个字节
* 类型：数据包的类型(即上层协议的类型)，长度为2字节
* 数据：被封装的数据包，长度为46~1500字节。
* 校验码：错误校验，长度为4字节

`Ethernet II`的主要特点是通过类型域标识了封装在帧里的上层数据所采用的协议，类型域是一个有效的指针。
对于`IEEE 802.3`标准的帧结构，由于没有了类型域(代之以长度域)，所以为了区别802.3数据帧中所封装的数据类型，`IEEE`引入了802.3SAP和802.3SNAP的标准。

802.3标准的以太网帧结构如下所示：

* 802.3SAP帧结构

| 目的地址 | 源地址 | 长度  | DSAP  | SSAP  | 控制  | 数据        | FCS   |
| -------- | ------ | ----- | ----- | ----- | ----- | ----------- | ----- |
| 6字节  | 6字节  | 2字节 | 1字节 | 1字节 | 1字节 | 43~1497字节 | 4字节 |

* 802.3SNAP帧结构

| 目的地址 | 源地址 | 长度  | 0xAA  | 0xAA  | 0x03  | OUI ID | 类型  | 数据        | FCS   |
| -------- | ------ | ----- | ----- | ----- | ----- | ------ | ----- | ----------- | ----- |
| 6字节 | 6字节  | 2字节 | 1字节 | 1字节 | 1字节 | 3字节  | 2字节 | 38~1492字节 | 4字节 |

**冲突域域广播域**

交换式以太网：这种系统的核心是一个交换机，交换机具有多个连接器，每个连接器有一个`10BASE-T`双绞线接口，可以连接一台主机。交换机还具有一块高速的底板，用于在连接器之间高速传输数据。

* 冲突域：在上述的交换式以太网结构当中，每一个连接器的接口构成了自己的冲突域。冲突域是冲突在其中发生并传播的区域。
* 广播域：在这些网络上的结点仍然属于同一个广播域。接收同样广播信息的结点的集合被称为一个广播域，在该集合中的任何一个结点传输一个广播帧，则所有其他能收到这个帧的节点都会被认为是该广播帧的一部分。

**交换机的工作原理**

交换机和网桥根据第二层MAC地址，通过一种确定性的方法在接口之间转发帧，帧的封装中不可缺少的信息是：

* 源和目的MAC地址；
* 高层协议常识；
* 错误检测信息。

第二层交换机通过源MAC地址来获悉与特定接口相连的设备的地址，并根据目的MAC地址来决定如何处理这个帧，它的3项主要功能如下：

* 学习(以太网交换机通过查看收到的每个帧的MAC地址，来学习每个接口连接的设备的MAC地址，地址到接口的映射被存储在被称为"MAC地址表"的数据库当中)

* 转发/过滤
	* 当交换机收到某一台主机发送的数据帧时，它会去自己的MAC地址表中查找对应的接口，如果查找不到，它会将数据帧发送至除自己的接收接口以外的全部接口，此时只有目的接口才会对此数据帧做出响应；
	* 如果将换季接口连接的是一台集线器，集线器上连接多台主机时，当交换机学习到这些主机的地址之后，这些主机之间传输的帧，交换机将不会将它们转发到其他端口；
	* 对于目标为广播和组播的帧，交换机会将这些帧转发至除了接收端口以外的所有端口。

* 消除环路(生成树协议)
	
	
**帧的转发方式**

交换机在接口之间传递帧的方式被称为转发模式或交换模式，主要的转发方式有三种：

* 直通转发(快速转发)
* 存储转发
* 无碎片直通转发(分段过滤，介于直通转发以及存储转发之间)

**交换机的访问方式**

对交换机的访问有以下4种方式：

* 通过带外方式对交换机进行管理(这种配置方式使用计算机的串口直接连接交换机的Console端口进行配置，并不占用网络带宽)
* 通过`Telnet`对交换机进行远程管理
* 通过`Web`对交换机进行远程管理
* 通过`SNMP`管理工作站对交换机进行远程管理

**命令模式**

锐捷网络交换机根据配置管理的功能可以分为：

* 用户模式 `Switch>` 访问交换机时首先进入该模式，输入exit命令离开该模式。使用该模式可以进行基本测试、显示系统信息。
* 特权模式 `Switch#` 在用户模式下，使用`enable`命令进入该模式。要返回到用户模式，输入`disable`命令。
* 配置模式
	* 全局模式 `Switch(config)#` 在特权模式下，使用`configure`或`configure terminal`命令进入该模式。要返回到特权模式，输入`exit`命令或`end`命令，或者输入`Ctrl+Z`组合键
	* 接口配置模式 `Switch(config-if)#` 在全局配置模式下，使用interface命令进入该模式，要返回到特权模式，输入`end`命令，或者输入`Ctrl+Z`组合键。要返回到全局配置模式，输入`exit`命令，在`interface`命令中必须指明要进入哪一个接口配置子模式，使用该模式配置交换机的各种接口。
	* `VLAN`工作模式 `Switch(config-vlan)#` 在全局配置模式下，使用`vlan vlan_id`命令进入该模式。使用该模式配置`VLAN`参数。要返回到特权模式，输入`end`命令，或输入`Ctrl+Z`组合键。要返回到全局配置模式，输入`exit`命令。
	* 线程工作模式


## 第三章 虚拟局域网(VLAN) 

**VLAN的优点**

VLAN具有以下优点：

* 限制广播包

* 安全性

* 虚拟工作组

* 减少移动和改变的代价

**VLAN的定义方法**

定义VLAN的方法有很多种，常见的包括：

* 基于接口的VLAN(静态VLAN)：根据交换机的接口来划分VLAN;
* 基于MAC地址的VLAN(基于用户VLAN)：根据每个主机网卡的MAC地址来划分的，即每个MAC地址的主机都被固定地配置属于一个VLAN。
* 基于网络层的VLAN
* 基于IP组播的VLAN

**VLAN的标准**

现在VLAN的标准是IEEE提出的802.1q协议，只要支持相同的开放标准，就能保证网络的互联互通。
如果一个VLAN的成员分布于不同的交换机上，它们之间互通时，如果只能在，每个VLAN内连接一条链路，必然会造成交换机接口的极大小号，每台交换机上可以连接的主机的接口数量随着VLAN数量的增加会大大减小。802.1q的出现，很好地解决了这个问题。

802.1q定义了基于接口的VLAN模型，这是使用得最多的一种方式。
802.1q标准主要用来解决如何将大型网络划分为多个小的网络，如此，广播和组播流量就不会占据更多的带宽，此外802.1q标准还提供更高的网络段间安全性。
`IEEE 802.1q`完成以上功能的关键在于标签。支持802.1q的交换接口可被配置来传输标签帧和无标签帧；但是对于不支持802.1q的设备相连的接口，则必须确保它们用于传输无标签帧，这一点非常重要，如果它们传输了带有标签的帧，它们会因为读不懂标签而丢弃该帧。

**Access接口**

`Access`接口(UnTagged接口)即接入接口，是交换机上的二层接口，发送出的数据帧是不带`IEEE 802.1q`标签的，而且只能接收以下3种格式的帧：

* `Untagged`帧;
* VLAN ID 为`Access`接口所属VLAN的`Tagged`帧;
* VLAN为0的`Tagged`帧。

①收发`Untagged`帧。
    * 接收：`Access`接口接收不带`IEEE 802.1q`标签的帧，并为无标签帧添加默认的VLAN的标签，然后发送出去。
    * 发送：发送帧前，先去掉帧上附带的VLAN标签，再发送。

②收发`Tagged`帧。
`Access`接口接收到的数据帧带有VLAN标签时，将按照以下条件进行处理
* 当标签的`VLAN ID`与默认的`VLAN ID`相同时，接收该数据帧，并在发送时去掉VLAN标签后发。
* 当标签的`VLAN ID`为0时，接收该数据帧，在标签中，`VLAN ID = 0`用于识别帧优先级
* 当标签的`VLAN ID`与默认`VLAN ID`不同且不为0时，丢弃该帧。

**Trunk接口**
`Trunk`接口(Tag Aware接口)即干道接口，是交换机上的二层接口，他可以接收`Untagged`帧和接口允许VLAN范围的`Tagged`帧。`Trunk`接口发送的默认的非默认VLAN的帧都是带标签的，而发送的默认VLAN的帧都不带标签。
①收发`Untagged`帧
* 若`Trunk`接口接收到的帧不带`IEEE 802.1q`标签，那么帧将在这个接口的默认VLAN中传输
②收发`Tagged`帧
若`Trunk`接口接收到的帧是带`IEEE 802.1q`标签的，那么帧将按照以下条件进行处理：
* 当`Trunk`接口接收到的帧所带标签的`VLAN ID`等于该`Trunk`接口的默认VLAN时，允许接收该数据帧；在发送该帧时，将去除标签后再发送；
* 当`Trunk`接口接收到的帧所带标签的`VLAN ID`不等于该`Trunk`接口的默认VLAN，但`VLAN ID`是该接口允许通过的`VLAN ID`时，接收该数据帧；发送时，将保持原有标签。
* 当`Trunk`接口接收到的帧所带标签的`VLAN ID`不等于该`Trunk`接口的默认VLAN，且`VLAN ID`是该接口不允许通过的`VLAN ID`时，丢弃该报文。

**VLAN和Trunk的配置**

* VLAN的配置
    * 添加或者修改VLAN、
        * 在特权模式下 `Switch#configure terminal`进入全局配置模式
        * `Switch(config)#vlan vlan-id`输入一个`VLAN ID`，如果输入的是一个新的`VLAN ID`，则交换机会创建该VLAN,如果输入的是已经存在的`VLAN ID`则修改对应的VLAN.
        * `Switch(config-vlan)#name vlan-name`为VLAN取一个名字。（可选）
        * `Switch(config-vlan)#end`回到特权命令模式
        * `Switch# show vlan{id vlan-id}`检查一下刚才的配置是否正确
    * 删除VLAN
        * 在特权模式下 `Switch# configure terminal`进入全局配置模式
        * `Switch(config)#no vlan vlan-id`输入一个`VLAN ID`,删除它，注意`VLAN1`不能删除
        * `Switch(config-vlan)#exit`回到特权命令模式
        * `Switch# show vlan{id vlan-id}`检查一下刚才的配置是否正确
        * 如果需要保存刚才的删除结果，可以继续使用`write`命令或者`copy`命令保存设置
    * 向VLAN内添加接口
        * 在特权模式下 `Switch#configure terminal`进入全局配置模式
        * `Switch(config)#interface interface-id`输入想要加入VLAN的接口编号。运行该命令即可进入接口配置模式。
        * `Switch(config-if)#switchport mode access`将端口配置为`access`口
        * `Switch(config-if)# switchport access vlan vlan-id`将端口指派到某VLAN

eg:

![enter description here][1]

* 配置VLAN Trunk
    * 在特权模式下 `Switch#configure terminal`进入全局配置模式
    * `Switch(config)#interface interface-id`输入想要加入VLAN的接口编号。运行该命令即可进入接口配置模式。
    * `Switch(config-if)#switchport mode trunk `将端口配置为`trunk`口
    * `Switch(config-if)#switchport trunk native vlan vlan-id`指定Trunk端口的Native VLAN
* 定义Trunk接口的许可VLAN列表

![enter description here][2]

* 定义Trunk接口的许可VLAN列表举例

![enter description here][3]


**配置VLAN间的通信**
VLAN的目的是隔离广播，并非要不同的主机彻底不能相互通信，但VLAN间的通信等同于不同广播域之间的通信，必须使用第三层的设备才能实现。VLAN间的通信就是指VLAN之间的路由，是VLAN之间在一个路由器或者其他三层设备上发生的路由。

* 利用路由器实现VLAN之间的通信
  
  * 单臂路由：在路由器的物理接口上创建多个子接口，不同的子接口用于转发不同VLAN标签的数据帧，从而实现不同VLAN之间的通信

    在路由器的特权模式下，利用如下步骤可以把一个快速以太网物理接口划分为多个子接口，并配置成干道模式：
    
    * `Router#configure terminal` 进入全局配置模式
    * `Router(config)# Interface interface-id`输入想要配置成干道的接口编号。(可选)
    * `Router(config-if)#no ip address(可选)`
      `Router(config-if)#exit`去掉该接口上的ip地址。如果确认接口上没有ip地址，则第二步、第三步可省略
    * `Router(config)#interface fastethernet slot-number/interface-number.subinterface-number`
        * 其中，`Slot-number/Interface-number`为槽号/物理接口序号
        * `Subinterface-number`为接口在物理接口上的序号，注意二者之间有标号“.”连接。
        该命令可在全局模式下直接使用，在第一次进入以太网子接口配置模式时即创建一个以太网子接口。
    * `Ruijie(config-subif)#encapsulation dotlq VlanID`配置VLAN封装标识，封装802.1q标准并指定`VLAN ID`号
    * `Router(config-subif)#ip address ip-address mask`指定子接口的ip地址。完成封装VLAN标识任务后，必须为封装VLAN标识的以太网子接口指定ip地址。
    * `Router(config-if)#end`回到特权命令模式
    * `Router#show running-config`检查一下刚才的配置是否正确
    * `Router#show ip route`检查配置的子接口所在的网段是否已经出现在路由表中。
    
  * 单臂路由的缺点   
      * 速度慢(收到接口带宽限制)
      * 转发速率低(路由器采用软件转发，转发速率比硬件转发方式的交换机慢)
      * 容易产生瓶颈

* 利用三层交换机实现VLAN间的通信

三层交换机，本质上就是带有路由功能的二层交换机。它可以实现高速路由。
在山城交换机上实现VLAN通信的具体实现方法是：在三层交换机上创建各个VLAN的虚拟接口(`Switch virtual interface,SVI`),并设置IP地址就可以了。SVI是交换虚拟接口，可以用来实现三层交换功能。
* 在特权模式下 `Switch#configure terminal`进入全局配置模式
![enter description here][4]
* `Switch(config-if)#end`回到特权命令模式
* `Switch#show running-config`检查一下刚才的配置是否正确
* `Switch#show ip route`检查配置的子接口所在的网段是否已经出现在路由表中。

  [1]: ./images/1514541661614.jpg
  [2]: ./images/1514541795435.jpg
  [3]: ./images/1514541854655.jpg
  [4]: ./images/1514548404852.jpg
  


  
  
